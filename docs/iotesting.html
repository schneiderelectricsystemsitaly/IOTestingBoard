<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv='cache-control' content='no-cache' />
    <meta http-equiv='expires' content='0' />
    <meta http-equiv='pragma' content='no-cache' />
    <title>IOTesting Board test page</title>
    <script src="./dist/bt-iotesting.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
</head>

<body onload="setInterval(refreshStatus, 450)">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
    <style>
        .output {
            background-color: #f0f0f0;
            border-radius: 0.75em;
            display: block;
            margin: 0.5em;
            padding: 0.5em;
        }

        .status {
            background-color: #b0b0b0;
            border-radius: 0.75em;
            display: block;
            margin: 0.5em;
            padding: 0.5em;
        }

        #status {
            margin: .5em 0;
            font-style: italic;
        }

        #log {
            margin: .5em 0;
            white-space: pre-wrap;
        }

        #status:empty,
        #log:empty,
        #content:empty {
            display: none;
        }

        .highlight {
            border-radius: 0.75em;
            border: 1px solid #f0f0f0;
            display: block;
            margin: 0.5em;
            overflow-x: auto;
            padding: 0.5em;
        }

        code {
            font-family: Inconsolata, Consolas, monospace;
        }
    </style>
    <h1>IOTesting<br /></h1>
    <div id="liveAlertPlaceholder"></div>
    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <p>
                    This webpage uses Web-Bluetooth to control an IOTesting board.
                    A recent browser and Bluetooth Low-energy interface is required in your device.
                </p>
                <br />
            </div>
        </div>
        <div class="row">
            <div class="col">
                <table class="table">
                    <tbody>
                        <tr>
                            <th scope="row" id="device-name">Device</th>
                            <td><span id="devicename">?</span></td>
                            <td><i class="bi bi-lightbulb-fill text-success" id="ready"></i>
                                <i class="bi bi-lightbulb-fill text-danger" id="notready"></i>
                            </td>
                            <td><i class="bi bi-hourglass-split" id="connecting"></i></td>
                        </tr>
                        <tr>
                            <th scope="row">Setpoint</th>
                            <td><span id="setpoint-value"></span>&nbsp;<span id="setpoint-unit"></span></td>
                            <td><strong>Actual</strong></td>
                            <td><span id="act-value"></span>&nbsp;<span id="act-unit"></span></td>
                        </tr>
                        <tr>
                            <th scope="row" id="device-name">Device info</th>
                            <td><i class="bi bi-battery"></i>&nbsp;<span id="battery">0 %</span></td>
                            <td>HW REV:<span id="hw-rev"></span>&nbsp;FW:<span id="fw-ver"></span></td>
                            <td>MODE</td>
                        </tr>
                        <tr>
                            <th scope="row">Last notification</th>
                            <td id="notification" colspan="3">
                                Mode:<i class="bi bi-box-arrow-right" id="not-bypass" alt="bypass"></i>
                                <i class="bi bi-toggles2" id="not-r" alt="resistor"></i>
                                <i class="bi bi-speedometer2" id="not-vload" alt="voltmeter with load"></i>
                                <i class="bi bi-question-circle" id="not-unknown"></i>&nbsp;
                                <i class="bi bi-list-check text-info" id="not-testmode" alt="test mode"></i>
                                <i class="bi bi-wifi text-success" id="not-wifion" alt="WiFi enabled"></i>
                                <i class="bi bi-wifi-off text-warning" id="not-wifioff" alt="WiFi disabled"></i>
                                <i class="bi bi-bluetooth text-primary" id="not-bt" alt="Bluetooth enabled"></i> -
                                Clock <i class="bi bi-1-circle-fill" id="not-speed1" alt="80 Mhz"></i><i
                                    class="bi bi-2-circle-fill" id="not-speed2" alt="160 Mhz"></i><i
                                    class="bi bi-3-circle-fill" id="not-speed3" alt="240 Mhz"></i>-
                                Result <i class="bi bi-x-circle text-warning" id="not-result-ko"></i><i
                                    class="bi bi-check2-circle text-success" id="not-result-ok"></i> -
                                <span id="not-memfree"></span> -
                                <i class="bi bi-exclamation-circle text-danger" id="not-error" alt="Board error"></i> -
                                #Com:<span id="not-numcomm"></span>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">Last refresh</th>
                            <td colspan="3">
                                <span id="ts"></span>
                            </td>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <button id="btnStart" class="btn btn-success">START</button>
                <button id="btnStop" class="btn btn-danger">STOP</button>
                &nbsp;
                <button id="btnDebugLog" class="btn btn-info">LOG (Debug)</button>
                <a class="btn btn-info" data-bs-toggle="collapse" href="#detailsCollapse" role="button"
                    aria-expanded="false" aria-controls="detailsCollapse">Details</a>
            </div>
        </div>
    </div>
    <div class="collapse" id="detailsCollapse">
        <div class="card card-body">
            Status:
            <div id="status" class="status">
                ?<br />
            </div>
        </div>
    </div>
    <div class="container-fluid" style="border:1px solid">
        <div class="row">
            <div class="col">
                Setpoint Resistance generation
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon1">Ω (65535=open)</span>
                    </div>
                    <input id="r_value" class="form-control" type="number" placeholder="input value"
                        aria-label="resistor" aria-describedby="basic-addon1" max="65535" min="0">
                </div>
            </div>
            <div class="col">
                <button id="btnExecuteR" class="btn btn-primary">Set to R mode</button>
                <br />
            </div>
        </div>
        <div class="row">
            <div class="col">
                Setpoint load with voltmeter
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon2">Ω (65535=open)</span>
                    </div>
                    <input id="r_load" class="form-control" type="number" placeholder="input value"
                        aria-label="resistor" aria-describedby="basic-addon2" max="65535" min="0">
                </div>
            </div>
            <div class="col">
                <button id="btnExecuteV" class="btn btn-primary">Set to V + load</button>
                <br />
            </div>
        </div>
        <div class="row">
            <div class="col">
                By-pass mode
            </div>
            <div class="col">
                &nbsp;no parameter
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnExecuteM" class="btn btn-primary">Set to Bypass</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Wi-Fi SSID
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <input id="wifissid" class="form-control" type="text">
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnExecuteWS" class="btn btn-primary">Set Wi-Fi SSID</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Wi-Fi Password
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <input id="wifipwd" class="form-control" type="text">
                </div>
            </div>
            <div class="col">
                <button id="btnExecuteWP" class="btn btn-primary">Set Wi-Fi Password</button>
                <br />
            </div>
        </div>
        <div class="row">
            <div class="col">
                Wi-Fi
            </div>
            <div class="col">
                <div class="checkbox">
                    <label><input id="en_wifi" type="checkbox" value="">tick to enable</label>
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnWifiOnce" class="btn btn-primary">Set Wi-Fi (once)</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Wi-Fi at boot
            </div>
            <div class="col">
                <div class="checkbox">
                    <label><input id="en_wifi_boot" type="checkbox" value="">tick to enable</label>
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnWifiBoot" class="btn btn-primary">Set Wi-Fi (always)</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Download updates OTA at reboot
            </div>
            <div class="col">
                <div class="checkbox">
                    <label><input id="en_ota" type="checkbox" value="">tick to enable</label>
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnOTA" class="btn btn-primary">Set OTA (always)</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Various
                <div class="input-group mb-3">
                    <button id="btnREPL" class="btn btn-primary">Start WEBREPL</button>
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnReboot" class="btn btn-primary">Reboot</button>
                </div>
                <div class="input-group mb-3">
                    <button id="btnTest" class="btn btn-primary">Auto-test mode</button>
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnBreak" class="btn btn-primary">Stop program</button>
                </div>
                <div class="input-group mb-3">
                    <button id="btnDeepsleep" class="btn btn-primary">Deep sleep</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label for="speed">Select speed:</label>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <select class="form-control" id="speed">
                        <option value="0">80 Mhz (default)</option>
                        <option value="1">160 Mhz (min. for Wi-Fi)</option>
                        <option value="2">240 Mhz (max)</option>
                    </select>
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnChangeCPU" class="btn btn-primary">Set CPU speed</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label for="speed">Bluetooth device name after reboot (persistent)</label>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <input type="text" id="bt-name" placeholder="Short name (16 chars)">
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnChangeName" class="btn btn-primary">Change BT name</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label for="speed">Enable commands via meter voltage (persistent)</label>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <input type="checkbox" id="bt-voltage">Tick to enable
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnMeterCommands" class="btn btn-primary">Set commands by meter</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Auto-shutdown delay (persistent)
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon3">Minutes (0=never)</span>
                    </div>
                    <input id="minutes" class="form-control" type="number" placeholder="input value"
                        aria-label="minutes" aria-describedby="basic-addon3" max="255" min="0">
                </div>
            </div>
            <div class="col">
                <button id="btnDelay" class="btn btn-primary">Set delay</button>
                <br />
            </div>
        </div>
    </div>

    <script language="javascript">
        function time(text) {
            log('[' + new Date().toJSON().substr(11, 8) + '] ' + text);
        }

        const alertPlaceholder = document.getElementById('liveAlertPlaceholder')

        const alert = (message, type) => {
            const wrapper = document.createElement('div')
            wrapper.innerHTML = [
                `<div class="alert alert-${type} alert-dismissible" role="alert">`,
                `   <div>${message}</div>`,
                '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                '</div>'
            ].join('')

            alertPlaceholder.append(wrapper)
        }

        async function execute(command) {
            result = await IOTestingBT.SimpleExecute(command)
            if (!result.success) {
                alert('The command has failed:' + result.message, 'info')
            } else {
                alert('Command successfully executed', 'warning')
            }
        }

        function bindButton(elementId, command) {
            document.getElementById(elementId).onclick = async () => { await execute(command) }
        }

        async function refreshStatus() {
            var new_sample = false;
            var status = await IOTestingBT.GetState();
            var driver = IOTestingBT.driver;
            document.getElementById("status").innerHTML = JSON.stringify(status);
            document.getElementById("devicename").innerHTML = status.deviceName
            document.getElementById("notready").style.display = status.ready ? 'none' : 'block';
            document.getElementById("ready").style.display = status.ready ? 'block' : 'none';
            document.getElementById("connecting").style.display = status.initializing ? 'block' : 'none';
            switch (status.lastSetpoint?.Value) {
                case 0xFF:
                    document.getElementById("setpoint-value").innerHTML = 'OPEN - ∞';
                    break;
                case 0xFE:
                    document.getElementById("setpoint-value").innerHTML = 'MAX';
                    break;
                case 0:
                    document.getElementById("setpoint-value").innerHTML = 'CLOSED (0)';
                    break;
                case -1:
                    document.getElementById("setpoint-value").innerHTML = '???';
                    break;
                default:
                    document.getElementById("setpoint-value").innerHTML = status.lastSetpoint?.Value;
            }
            document.getElementById("setpoint-unit").innerHTML = status.lastSetpoint?.Units;
            document.getElementById("ts").innerHTML = status.lastMeasure?.Timestamp;
            switch (status.lastMeasure?.Value) {
                case 0xFF:
                    document.getElementById("act-value").innerHTML = 'OPEN - ∞';
                    break;
                case 0:
                    document.getElementById("act-value").innerHTML = 'CLOSED - 0';
                    break;
                case -1:
                    document.getElementById("act-value").innerHTML = '???';
                    break;
                default:
                    document.getElementById("act-value").innerHTML = status.lastMeasure?.Value;
            }
            document.getElementById("act-unit").innerHTML = status.lastMeasure?.Units;
            document.getElementById("battery").innerHTML = status.batteryLevel + "%";
            document.getElementById("hw-rev").innerHTML = status.deviceHwRev;
            document.getElementById("fw-ver").innerHTML = status.firmware;
            // Notification data
            document.getElementById("not-wifion").style.display = status.notification.WiFi == 2 ? 'inline' : 'none';
            document.getElementById("not-wifioff").style.display = status.notification.WiFi == 1 ? 'inline' : 'none';

            document.getElementById("not-unknown").style.display = status.notification.Relay == 0 ? 'inline' : 'none';
            document.getElementById("not-bypass").style.display = status.notification.Relay == 1 ? 'inline' : 'none';
            document.getElementById("not-r").style.display = status.notification.Relay == 2 && !status.notification.V_with_load ? 'inline' : 'none';
            document.getElementById("not-vload").style.display = status.notification.V_with_load ? 'inline' : 'none';

            document.getElementById("not-bt").style.display = status.notification.Bluetooth == 2 || status.notification.Bluetooth == 3 ? 'inline' : 'none';
            document.getElementById("not-speed1").style.display = status.notification.Frequency == 1 ? 'inline' : 'none';
            document.getElementById("not-speed2").style.display = status.notification.Frequency == 2 ? 'inline' : 'none';
            document.getElementById("not-speed3").style.display = status.notification.Frequency == 3 ? 'inline' : 'none';
            document.getElementById("not-testmode").style.display = status.notification.Test ? 'inline' : 'none'
            document.getElementById("not-result-ok").style.display = status.notification.LastResult ? 'inline' : 'none';
            document.getElementById("not-result-ko").style.display = !status.notification.LastResult ? 'inline' : 'none';
            document.getElementById("not-memfree").innerHTML = 'RAM: ' + Math.round(status.notification.Memfree / 1024).toString() + " Kb";
            document.getElementById("not-numcomm").innerHTML = status.notification.CommandCpt.toString();
        }

        // Buttons binding
        document.getElementById("btnStart").onclick = async () => { await IOTestingBT.Pair(true) };
        document.getElementById("btnStop").onclick = async () => { await IOTestingBT.Stop() };
        document.getElementById("btnDebugLog").onclick = async () => { await IOTestingBT.setLevel(1) };

        // Commands button binding
        bindButton("btnExecuteM", IOTestingBT.Command.CreateNoSP(
            IOTestingBT.CommandType.COMMAND_MODE_METER))
        bindButton("btnExecuteR", IOTestingBT.Command.CreateOneSP(
            IOTestingBT.CommandType.COMMAND_MODE_RESISTORS,
            document.getElementById("r_value").value));

        bindButton("btnExecuteV", IOTestingBT.Command.CreateOneSP(
            IOTestingBT.CommandType.COMMAND_MODE_V_LOAD,
            document.getElementById("r_load").value));

        bindButton("btnExecuteWS", IOTestingBT.Command.CreateOneSP(
            IOTestingBT.CommandType.COMMAND_SET_WIFI_NETWORK,
            document.getElementById("wifissid").value))
        bindButton("btnExecuteWP", IOTestingBT.Command.CreateOneSP(
            IOTestingBT.CommandType.COMMAND_SET_WIFI_PASSWORD,
            document.getElementById("wifipwd").value))
        bindButton("btnReboot", IOTestingBT.Command.CreateNoSP(
            IOTestingBT.CommandType.COMMAND_REBOOT))

        bindButton("btnBreak", IOTestingBT.Command.CreateNoSP(
            IOTestingBT.CommandType.COMMAND_BREAK));

        bindButton("btnChangeName", IOTestingBT.Command.CreateOneSP(
            IOTestingBT.CommandType.COMMAND_SET_BLUETOOTH_NAME,
            document.getElementById("bt-name").value))

        bindButton("btnChangeName", IOTestingBT.Command.CreateOneSP(
            IOTestingBT.CommandType.COMMAND_SET_BLUETOOTH_NAME,
            document.getElementById("bt-name").value))

        bindButton("btnWifiOnce", IOTestingBT.Command.CreateNoSP(
            document.getElementById("en_wifi").checked ? IOTestingBT.CommandType.COMMAND_ENABLE_WIFI : IOTestingBT.CommandType.COMMAND_DISABLE_WIFI))

        bindButton("btnWifiBoot", IOTestingBT.Command.CreateOneSP(IOTestingBT.CommandType.COMMAND_SET_INITIAL_WIFI,
            document.getElementById("en_wifi_boot").checked))

        bindButton("btnOTA", IOTestingBT.Command.CreateOneSP(IOTestingBT.CommandType.COMMAND_SET_OTA,
            document.getElementById("en_ota").checked))

        bindButton("btnChangeCPU", IOTestingBT.Command.CreateOneSP(IOTestingBT.CommandType.COMMAND_SET_CPU,
            document.getElementById("speed").value))

        bindButton("btnMeterCommands", IOTestingBT.Command.CreateOneSP(IOTestingBT.CommandType.COMMAND_SET_INITIAL_METER_COMM,
            document.getElementById("bt-voltage").checked))

        bindButton("btnDelay", IOTestingBT.Command.CreateOneSP(IOTestingBT.CommandType.COMMAND_SET_DEEPSLEEP_MIN,
            document.getElementById("minutes").value))

        bindButton("btnTest", IOTestingBT.Command.CreateNoSP(
            IOTestingBT.CommandType.COMMAND_RUN_TEST))

        bindButton("btnDeepsleep", IOTestingBT.Command.CreateNoSP(
            IOTestingBT.CommandType.COMMAND_DEEP_SLEEP))

        bindButton("btnREPL", IOTestingBT.Command.CreateNoSP(
            IOTestingBT.CommandType.COMMAND_ENABLE_WEBREPL))

    </script>
</body>

</html>