<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv='cache-control' content='no-cache' />
    <meta http-equiv='expires' content='0' />
    <meta http-equiv='pragma' content='no-cache' />
    <title>IOTesting Board test page</title>
    <script src="./dist/bt-iotesting.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
</head>

<body onload="setInterval(refreshStatus, 450)">
    <style>
        .output {
            background-color: #f0f0f0;
            border-radius: 0.75em;
            display: block;
            margin: 0.5em;
            padding: 0.5em;
        }

        .status {
            background-color: #b0b0b0;
            border-radius: 0.75em;
            display: block;
            margin: 0.5em;
            padding: 0.5em;
        }

        #status {
            margin: .5em 0;
            font-style: italic;
        }

        #log {
            margin: .5em 0;
            white-space: pre-wrap;
        }

        #status:empty,
        #log:empty,
        #content:empty {
            display: none;
        }

        .highlight {
            border-radius: 0.75em;
            border: 1px solid #f0f0f0;
            display: block;
            margin: 0.5em;
            overflow-x: auto;
            padding: 0.5em;
        }

        code {
            font-family: Inconsolata, Consolas, monospace;
        }
    </style>
    <h1>IOTesting<br /></h1>
    <div class="container">
        <div class="row">
            <div class="col">
                <p>
                    This webpage uses Web-Bluetooth to control an IOTesting board.
                    A Bluetooth Low-energy interface is required in your device.
                <ul>
                    <li>Then click Connect and select "IOTesting"
                </ul>
                </p>
                <br />
                Status:<div id="status" class="status">?</div><br />
                <button id="btnStart" class="btn btn-primary">START</button>
                <button id="btnStop" class="btn btn-primary">STOP</button>
                &nbsp;
                <button id="btnDebugLog" class="btn btn-info">LOG (Debug)</button>
                <br /><br />
                <strong>Latest data:</strong>
                <div id="measure" class="output"></div>
            </div>
            <div class="col">
                <img src="iotesting.png" />
            </div>
            <div class="col">
                <strong>Statistics:</strong>
                <div id="stats" class="output"></div>
                Logs (see Developer Tools console):
                <ul>
                    <li>To adjust: IOTestingBT.SetLogLevel(value 0..5) where 0=TRACE, 5=SILENT</li>
                    <li>To enable packet logging into application local storage : IOTestingBT.SetPacketLog(true)</li>
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Setpoint Resistance generation
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon1">Ω (65535=open)</span>
                    </div>
                    <input id="r_value" class="form-control" type="number" placeholder="input value" aria-label="resistor" aria-describedby="basic-addon1" max="65535" min="0">
                </div>
            </div>
            <div class="col">
                <button id="btnExecuteR" class="btn btn-primary">Set to R mode</button>
                <br/>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Setpoint load with voltmeter
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon2">Ω (65535=open)</span>
                    </div>
                    <input id="r_load" class="form-control" type="number" placeholder="input value" aria-label="resistor" aria-describedby="basic-addon2" max="65535" min="0">
                </div>
            </div>
            <div class="col">
                <button id="btnExecuteV" class="btn btn-primary">Set to V + load</button>
                <br/>
            </div>
        </div>
        <div class="row">
            <div class="col">
                By-pass mode
            </div>
            <div class="col">
                &nbsp;no parameter
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnExecuteM" class="btn btn-primary">Set to Bypass</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Wi-Fi SSID
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <input id="wifissid" class="form-control" type="text">
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnExecuteWS" class="btn btn-primary">Set Wi-Fi SSID</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Wi-Fi Password
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <input id="wifipwd" class="form-control" type="text">
                </div>
            </div>
            <div class="col">
                <button id="btnExecuteWP" class="btn btn-primary">Set Wi-Fi Password</button>
                <br/>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Wi-Fi
            </div>
            <div class="col">
                <div class="checkbox">
                    <label><input id="en_wifi" type="checkbox" value="">tick to enable</label>
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnWifiOnce" class="btn btn-primary">Set Wi-Fi (once)</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Wi-Fi at boot
            </div>
            <div class="col">
                <div class="checkbox">
                    <label><input id="en_wifi_boot" type="checkbox" value="">tick to enable</label>
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnWifiBoot" class="btn btn-primary">Set Wi-Fi (always)</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Download updates OTA at reboot
            </div>
            <div class="col">
                <div class="checkbox">
                    <label><input id="en_ota" type="checkbox" value="">tick to enable</label>
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnOTA" class="btn btn-primary">Set OTA (always)</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Various
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnReboot" class="btn btn-primary">Reboot</button>
                </div>
                <div class="input-group mb-3">
                    <button id="btnTest" class="btn btn-primary">Auto-test mode</button>
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnBreak" class="btn btn-primary">Stop program</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label for="speed">Select speed:</label>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <select class="form-control" id="speed">
                        <option value="0">80 Mhz (default)</option>
                        <option value="1">160 Mhz (min. for Wi-Fi)</option>
                        <option value="2">240 Mhz (max)</option>
                    </select>
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnChangeCPU" class="btn btn-primary">Set CPU speed</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label for="speed">Bluetooth device name after reboot (persistent)</label>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <input type="text" id="bt-name" placeholder="Short name (16 chars)">
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnChangeName" class="btn btn-primary">Change BT name</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label for="speed">Enable commands via meter voltage (persistent)</label>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <input type="checkbox" id="bt-voltage">Tick to enable
                </div>
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <button id="btnMeterCommands" class="btn btn-primary">Set commands by meter</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                Auto-shutdown delay (persistent)
            </div>
            <div class="col">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon3">Minutes (0=never)</span>
                    </div>
                    <input id="minutes" class="form-control" type="number" placeholder="input value" aria-label="minutes" aria-describedby="basic-addon3" max="255" min="0">
                </div>
            </div>
            <div class="col">
                <button id="btnDelay" class="btn btn-primary">Set delay</button>
                <br/>
            </div>
        </div>
    </div>
   
    <script language="javascript">
        chartData = [];
        lastData = null;
        previousData = null;
        /* HELPERS */
        function time(text) {
            log('[' + new Date().toJSON().substr(11, 8) + '] ' + text);
        }
        var init = 0;

        async function refreshStatus() {
            var new_sample = false;
            var status = await IOTestingBT.GetState();
            var driver = IOTestingBT.driver;
            document.getElementById("status").innerHTML = JSON.stringify(status);
            document.getElementById("stats").innerHTML = JSON.stringify(driver.btState?.stats).replaceAll(',', '<br/>');
        }

        // Buttons binding
        document.getElementById("btnStart").onclick = async () => { await IOTestingBT.Pair(true) };
        document.getElementById("btnStop").onclick = async () => { await IOTestingBT.Stop() };
        document.getElementById("btnDebugLog").onclick = async () => { await IOTestingBT.setLevel(1) };

        document.getElementById("btnExecuteM").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateNoSP(IOTestingBT.CommandType.COMMAND_MODE_METER)) };
        document.getElementById("btnExecuteR").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateOneSP(
                IOTestingBT.CommandType.COMMAND_MODE_RESISTORS, 
                document.getElementById("r_value").value)) };
        document.getElementById("btnExecuteV").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateOneSP(
                IOTestingBT.CommandType.COMMAND_MODE_V_LOAD, 
                document.getElementById("r_load").value)) };
        document.getElementById("btnExecuteWS").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateOneSP(
                IOTestingBT.CommandType.COMMAND_SET_WIFI_NETWORK, 
                document.getElementById("wifissid").value)) };
        document.getElementById("btnExecuteWP").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateOneSP(
                IOTestingBT.CommandType.COMMAND_SET_WIFI_PASSWORD, 
                document.getElementById("wifipwd").value)) };
        document.getElementById("btnReboot").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateNoSP(
                IOTestingBT.CommandType.COMMAND_REBOOT)) };
        document.getElementById("btnBreak").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateNoSP(
                IOTestingBT.CommandType.COMMAND_BREAK)) };        
        document.getElementById("btnChangeName").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateOneSP(
                IOTestingBT.CommandType.COMMAND_SET_BLUETOOTH_NAME, 
                document.getElementById("bt-name").value)) };
        document.getElementById("btnWifiOnce").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateNoSP(
                document.getElementById("en_wifi").checked ? IOTestingBT.CommandType.COMMAND_ENABLE_WIFI : IOTestingBT.CommandType.COMMAND_DISABLE_WIFI)) };
        document.getElementById("btnWifiBoot").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateOneSP(IOTestingBT.CommandType.COMMAND_SET_INITIAL_WIFI,
                document.getElementById("en_wifi_boot").checked)) };
        document.getElementById("btnOTA").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateOneSP(IOTestingBT.CommandType.COMMAND_SET_OTA,
                document.getElementById("en_ota").checked)) };
        document.getElementById("btnChangeCPU").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateOneSP(IOTestingBT.CommandType.COMMAND_SET_CPU,
                document.getElementById("speed").value)) };
        document.getElementById("btnMeterCommands").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateOneSP(IOTestingBT.CommandType.COMMAND_SET_INITIAL_METER_COMM,
                document.getElementById("bt-voltage").checked)) };
        document.getElementById("btnDelay").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateOneSP(IOTestingBT.CommandType.COMMAND_SET_DEEPSLEEP_MIN,
                document.getElementById("minutes").value)) };
        document.getElementById("btnTest").onclick = async () => { await IOTestingBT.SimpleExecute(
            IOTestingBT.Command.CreateNoSP(
                IOTestingBT.CommandType.COMMAND_RUN_TEST)) };  
    </script>

</body>

</html>